<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='UTF-8' />
        <meta name='viewport' content='width=device-width, initial-scale=1.0' />
        <title>Job Spreadsheet Assistant</title>
    </head>
    <body>
        <h2 id="question"></h2>
        <p id="test"></p>
        <form id="form">
            <input type="text" id="user_input" placeholder="" />
            <button type="submit" id="submit">Skip</button>
            <button type="reset" id="reset">Reset</button>
        </form>
        <button onclick="window.location.href='index.html'">Back to Home</button>
        <script>
            const { ipcRenderer, shell } = require('electron');
            const SERVER_URL = "http://127.0.0.1:5000";
            const questionHeader=document.getElementById("question");
            const form=document.getElementById("form");
            const input=document.getElementById("user_input");
            const submitBtn=document.getElementById("submit");
            /* GET QUESTION */
            /**
             * For the first question, get the question's text and the info on the next question from the request response
             * For subsequent questions, that info will have been passed into session variables from the question prior,
             * so just get them from there.
            */
            let first_q=sessionStorage.getItem("first_q");
            let has_next="";
            let next_a_type="";
            function loadQuestion(){
                if(first_q=="true"){
                    console.log("This is the first question");
                    fetch(`${SERVER_URL}/get_first_question`,{ method: "GET" })
                    .then(response=>response.json())
                    .then(data=>{
                        questionHeader.innerText=data.q_str;
                        has_next=data.has_next;
                        console.log("has_next is:",has_next);
                        if(has_next=="true"){
                            next_a_type=data.next_a_type;
                            console.log("next_a_type is",next_a_type)
                        }
                    })
                    .catch(error=>console.error("An error was recieved: ",error));
                    sessionStorage.setItem("first_q","false");  //change flag
                }else{
                    /* Get all the session variables from sessionStorage */
                    q=sessionStorage.getItem("next_q_str");
                    console.log("q is",q);
                    questionHeader.innerText=q;
                    has_next=sessionStorage.getItem("has_next");
                    if(has_next=="true"){
                        next_a_type=sessionStorage.getItem("next_a_type");
                        console.log("next_a_type is",next_a_type)
                    }else{
                        console.log("This is the last question");
                    }
                }
            }
            loadQuestion();
            
            /* When an input is entered, change button text */
            input.addEventListener('input', e => {
                submitBtn.innerHTML="Submit";
            });

            /* FORM SUBMISSION */
            function submitAnswer(answer){
                answer=answer.trim();
                fetch(`${SERVER_URL}/add_answer/${answer}`,{method:"POST"})
                .then(response=>response.text())
                .then(data=>console.log("data"));
            }

            /* NEXT QUESTION & EXPORTS */
            function loadNextQuestion(){
                //set the text of the next question
                fetch(`${SERVER_URL}/get_next_question`,{ method: "GET" })
                .then(response=>response.json())
                .then((data)=>{
                    /* Set all the session variables */
                    sessionStorage.setItem("next_q_str",data.q_str);
                    console.log("The next question is",sessionStorage.getItem("next_q_str"));
                    sessionStorage.setItem("has_next",data.has_next);
                    sessionStorage.setItem("next_a_type",data.next_a_type);
                    //change what page we go to depending on the a_type of the next question
                    if(next_a_type=="multiple-choice"){
                        console.log("The next question is multiple choice");
                        form.action="answerQuestion-multiple_choice.html";
                    }else if(next_a_type=="open-ended"){
                        console.log("The next question is open-ended");
                        form.action="answerQuestion-open_ended.html";
                    }
                    window.location.href=form.action;   //load page of next question
                });
            }
            form.addEventListener("submit",(event)=>{
                event.preventDefault();
                submitAnswer(input.value);  //pass the answer to the backend
                //if there is a next question
                if(has_next=="true"){
                    loadNextQuestion();
                }else{  //this is the last question
                    if(confirm("This is the last question. Do you wish to submit all your answers?")){
                        console.log("Answer submission confirmed");
                        /* Get and add all the answers to be exported */
                        // fetch(`${SERVER_URL}/get_all_answers`,{ method: "GET" })
                        // .then(response=>response.json())
                        // .then(data=>console.log(data));
                        fetch(`${SERVER_URL}/add_all_answers`,{ method:"POST" })
                        .then(response=>response.text())
                        .then(data=>console.log(data));

                        /* Send request to connect to export method and upload data */
                        fetch(`${SERVER_URL}/get_export_method`,{method: "GET"})
                        .then(response=>response.text()).then(data=>{
                            console.log("Export method is: ",data);
                            if(data=="sheets"){
                                return fetch(`${SERVER_URL}/get_auth_url`,{method: "GET"});
                            }
                        })  //end of get_export_method chain, start of get_auth_url chain
                        .then(response=>response.json()).then(data=>{
                            /* Sheets */
                            if(data.auth_url){
                                //send message to ipcMain to open popup and get code
                                ipcRenderer.send("open-auth-window", data.auth_url);
                            }else if(data.message){ //a valid token.json exists, so there's no need to reauthenticate, just export
                                console.log(data.message);
                                fetch(`${SERVER_URL}/export_data/sheets`,{ method: "POST" })
                                .then(response=>response.text()).then(data=>alert(data));
                            }
                            /* CSV */
                        })
                        .catch(err=>console.error("Export request failed",err));
                    }
                }
            });
            
            /* Listen for the trigger from ipcMain in main.js
             * Activated on the authorization code successfully being gotten
             * Once it is, just pass it to the backend
             */
            ipcRenderer.on("auth-code-recieved", (event, code)=>{
                console.log("renderer trigger recieved");
                fetch(`${SERVER_URL}/receive_auth_code`,{
                    method: "POST",
                    headers:{
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({code:code}),
                })
                .then(response=>{
                    console.log("Authentification complete");
                    return response.json();
                }).then(data=>{
                    if(data.success_message){
                        console.log(data.success_message);
                        /* TODO: Add fetch request to finally export the data */
                        fetch(`${SERVER_URL}/export_data/sheets`,{ method: "POST" })
                        .then(response=>response.text()).then(data=>alert(data));
                    }else{
                        //there was an error
                        console.error(data.error);
                    }
                })
                .catch(err=>console.error("Authentification failed: ",err));
            })
        </script>
    </body>
</html>